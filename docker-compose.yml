services:
  # SQLite database service
  # SQLite stores data in a mounted volume for persistence
  sqlite:
    image: alpine:latest
    container_name: sqlite-db
    volumes:
      - ./data/sqlite:/data
    environment:
      - SQLITE_DATA_DIR=/data
    command: sh -c "mkdir -p /data && touch /data/app.db && tail -f /dev/null"
    healthcheck:
      test: ['CMD', 'test', '-f', '/data/app.db']
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO object storage service
  # Provides S3-compatible storage for media assets and uploads
  minio:
    image: minio/minio:latest
    container_name: minio-server
    ports:
      - '9000:9000'
      - '9001:9001'
    volumes:
      - ./data/minio:/data
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
      MINIO_VOLUMES: /data
    command: >
      server /data --console-address ":9001"
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      - sqlite

  # MinIO bucket initialization
  # Creates required buckets after MinIO starts
  minio-init:
    image: minio/mc:latest
    container_name: minio-init
    entrypoint: >
      /bin/sh -c "
      until (/usr/bin/mc config host add minio http://minio:9000 minioadmin minioadmin123) do echo 'waiting for minio'; sleep 1; done;
      /usr/bin/mc mb minio/assets --ignore-existing;
      /usr/bin/mc mb minio/uploads --ignore-existing;
      /usr/bin/mc mb minio/temp --ignore-existing;
      /usr/bin/mc policy set public minio/assets;
      exit 0;
      "
    depends_on:
      - minio

volumes:
  sqlite_data:
    driver: local
  minio_data:
    driver: local

networks:
  default:
    name: dev-network
